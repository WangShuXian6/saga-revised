<html>

<head>
  <META http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>如何编写任务脚本</title>
  <link rel="stylesheet" href="stylesheet/stylesheet.css">
</head>

<body>
  <table class="container" cellspacing="0">
    <tr>
      <td style="padding:0px; margin:0px;">
        <div class="overlay_top">
          <div class="overlay_bottom">
            <table class="container" cellspacing="0">
              <tr>
                <td class="container_corner_upper_left"></td>
                <td class="container_top">
                  <div style="padding-left:130px; position:relative; top:10px;">
                    <a href="Introduction.html" class="menulink">主页</a> |
                    <a href="eula.html" class="menulink">许可协议</a> |
                    <a href="changelog.html" class="menulink">更新日志</a> |
                    <a href="features.html" class="menulink">功能</a> |
                    <a href="todo.html" class="menulink">项目状态</a> |
                    <a href="toc.techdoc.html" class="menulink">技术文档</a>
                  </div>
                </td>
                <td class="container_corner_upper_right"></td>
              </tr>
              <tr>
                <td class="container_left"></td>
                <td valign="top">
                  <div><img class="pagetitle" src="Images/menu_large/techdoc.png"></div>
                  <div>
                    <h2>如何编写任务脚本</h2>
                    <p>你需要一个SVN客户端，如Tortoise
                      SVN或Subversion。安装好客户端后，你可以从https://svn1.hosted-projects.com/SagaE/SagaRev/Quests/进行检出，这是我们所有脚本任务的Subversion库。任务文件中会有一个名为“Quest-Progress.txt”的文件，里面包含了脚本任务的当前进度。任务被保存在未打包的形式，文件名如“{QuestId}.lua”。
                    </p>
                    <p>
                      在我们的论坛中，你可以找到各种基于XML的文件，这些文件包含了供脚本编写者使用的信息。你可以使用这些文件作为参考，查找物品ID、操作对象和NPC。我们使用数字ID，因为它对服务器更有利，并且减少了拼写错误的可能性。
                    </p>
                    <p>请打开我们SVN库中的任务174。你会注意到任务以以下内容开始：</p>

                    <code><pre class="code">
-- Saga 许可证：创作共用（署名-非商业性使用-相同方式共享 3.0）
-- http://creativecommons.org/licenses/by-nc-sa/3.0/
-- 由Quest Extractor生成，时间：2008年2月8日下午3:46:15

local QuestID = 174;
local ReqClv = 16;
local ReqJlv = 0;
local NextQuest = 175;
local RewZeny = 300;
local RewCxp = 1700;
local RewJxp = 680;
local RewWxp = 0; 
local RewItem1 = 1700113; 
local RewItem2 = 0; 
local RewItemCount1 = 3; 
local RewItemCount2 = 0; 
local StepID = 0;   

-- 在下面修改步骤以便进行游戏
</pre></code>

                    <p>
                      这是任务的头部信息。我们在这个通用头部中收集并更新信息。这些信息是通过我们创建的包日志数据库中的工具生成的。使用这个头部信息可以让管理所有任务变得更加轻松。所有这些变量在函数外部声明，因此它们是全局可访问的。在你看到的大部分脚本任务中，你会发现它们使用了这些变量之一或多个。这样做是因为你只需要更改任务所需的字段。
                    </p>
                    <p>如果我们检查任务的正文部分，我们可以找到四个重要的入口点供我们的服务器使用：</p>

                    <code><pre class="code">
QUEST_START(cid) 当任务开始时调用此函数 
QUEST_FINISH(cid) 当用户按下“完成”按钮时调用此函数
QUEST_CANCEL(cid) 当用户取消任务时调用此函数
QUEST_CHECK(cid) 当检查任务进度时调用此函数
</pre></code>

                    <p>
                      现在，为了开始，请参考XML数据库中的“QuestStepData.xml”文件。这个文件包含了一个人完成任务所需的所有动作。每个任务由多个步骤组成，这些步骤是建立在子步骤之上的。步骤必须按创建的顺序完成，而子步骤可以随机完成。当我们查看XML文件时，我们会看到许多以“script{n}”命名的XML标签（其中n是从1到22的数字）。每个脚本包含有关动作类型的信息。为什么它们被分开存储尚不清楚，但它有助于验证任务是否按预期执行。
                    </p>
                    <p>如果你查看任务174的所有步骤，你会看到：17401 - 与Volker Stanwood交谈；17402 - 消灭孢子（7）；17403 - 向Kafra
                      Board邮箱提交。我们可以明显看出任务有三个步骤。因此，我们将这三个步骤添加到任务检查和任务开始的函数中。以下是这两个函数的代码：</p>

                    <code><pre class="code">
function QUEST_START(cid)    
    Saga.AddStep(cid, QuestID, 17401);
    Saga.AddStep(cid, QuestID, 17402);    
    Saga.AddStep(cid, QuestID, 17403);   
    Saga.InsertQuest(cid, QuestID, 1);    
    return 0;
end

function QUEST_CHECK(cid)
    local CurStepID = Saga.GetStepIndex(cid, QuestID );
    StepID = CurStepID;
    local ret = -1;

    if CurStepID == 17401 then
        ret = QUEST_STEP_1(cid);
    elseif CurStepID == 17402 then   
        ret = QUEST_STEP_2(cid);  
    elseif CurStepID == 17403 then   
        ret = QUEST_STEP_3(cid);          
    end
    
    if ret == 0 then
        QUEST_CHECK(cid)
    end
    
    return ret;    
end
</pre></code>

                    <p>
                      正如你所注意到的，我们通过使用“QUEST_STEP_{n}”来添加任务的每个步骤，其中n是任务执行的顺序数字。如果你在某个步骤函数中返回-1，它将中止该步骤。但是，如果返回0，则会中止并重新检查步骤。假设你完成了某个步骤并返回0，那么它不会重新检查该步骤，而是检查下一个步骤。
                    </p>

                    <code><pre class="code">
function QUEST_STEP_1(cid)  
    -- 与Volker Stanwood交谈
    Saga.AddWaypoint(cid, QuestID, StepID, 1,1009);      
    
    -- 检查是否完成
    local ret = Saga.GetNPCIndex(cid);    
    if ret == 1009 then
        Saga.GeneralDialog(cid, 3936);               
        Saga.SubstepComplete(cid, QuestID, StepID, 1);                
    end    
    
    -- 检查所有子步骤是否完成
    for i = 1, 1 do
         if Saga.IsSubStepCompleted(cid,QuestID,StepID, i) == false then
            return -1;
         end
    end        
    
    Saga.StepComplete(cid, QuestID, StepID);
    Saga.ClearWaypoints(cid, QuestID); 
    return 0;
end
</pre></code>

                    <p>上面的代码是第一个步骤的代码片段。我们之前提到的第一个步骤是与Volker Stanwood交谈。如果你在“npc.xml”文件中查找Volker
                      Stanwood，你会发现他的NPCID是1009。数字1代表子步骤。如果你需要与多个NPC交谈，你将为每个子步骤ID添加“AddWaypoint”函数。子步骤总是从1开始，并随着每个额外的子步骤递增。
                    </p>
                    <p>接下来是任务的其余部分。</p>

                    <code><pre class="code">
function QUEST_STEP_2(cid)
    -- 消灭孢子（7）
    Saga.Eliminate(cid, QuestID, StepID, 10081, 7, 1);
	Saga.Eliminate(cid, QuestID, StepID, 10082, 7, 1); 
	
    -- 检查所有子步骤是否完成
    for i = 1, 1 do
         if Saga.IsSubStepCompleted(cid,QuestID,StepID, i) == false then
			return -1;
		 end
    end	
	
    Saga.StepComplete(cid, QuestID, StepID);     
    return 0;
end

function QUEST_STEP_3(cid)
    -- 向Kafra Board邮箱提交
    local ret = Saga.GetActionObjectIndex(cid);    
    if ret == 1123 then
        Saga.SubstepComplete(cid, QuestID, StepID, 
        1);
        end
        
        -- 检查所有子步骤是否完成
        for i = 1, 1 do
             if Saga.IsSubStepCompleted(cid,QuestID,StepID, i) == false then
                return -1;
             end
        end        
        
        Saga.StepComplete(cid, QuestID, StepID);
        Saga.ClearWaypoints(cid, QuestID); 
        return 0;
    end
    </pre></code>

                    <p>这是任务的最后两步，清晰地展示了如何完成任务。你只需要替换“questStep_{n}”中的n，并填写所需的参数。</p>
                    <p>希望这篇文档对你有帮助！</p>
                  </div>
                </td>
                <td class="container_right"></td>
              </tr>
              <tr>
                <td class="container_corner_lower_left"></td>
                <td class="container_bottom"></td>
                <td class="container_corner_lower_right"></td>
              </tr>
            </table>
          </div>
        </div>
      </td>
    </tr>
  </table>
</body>

</html>